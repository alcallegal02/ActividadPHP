Te voy a explicar la estructura de mi proyecto para que me ayudes a solucionar errores y implementar nuevas funcionalidades que quiero ponerle. En primer lugar en mi directorio raiz tenemos dos carpetas, una llamada controller y templates. Dentro de controller tengo dos carpetas una llamada db y otra llamada forms. Dentro de db tengo los archivos auth:

<?php
session_start();

// Función para verificar si el usuario está autenticado
function isAuthenticated() {
    return isset($_SESSION['user_id']);
}

// Redirige al usuario al login si no está autenticado
function requireAuth() {
    if (!isAuthenticated()) {
        header('Location: ../../templates/forms/login.php');  // Asegúrate de que esta URL sea correcta
        exit();
    }
}
?>




Y el archivo config:

<?php
define('USER', 'root');
define('PASSWORD', '');
define('HOST', 'localhost');
define('DATABASE', 'actphp');
try {
    $connection = new PDO("mysql:host=".HOST.";dbname=".DATABASE, USER, PASSWORD);
} catch (PDOException $e) {
    exit("Error: " . $e->getMessage());
}
?>




En la carpeta forms tengo los archivos login:

<?php
include('../db/config.php');
session_start();

// Verifica si ya está logueado
if (isset($_SESSION['user_id'])) {
    header('Location: ../../templates/product/product_list.php');
    exit();
}

if (isset($_POST['login'])) {
    $username = $_POST['username'];
    $password = $_POST['password'];

    $query = $connection->prepare("SELECT * FROM users WHERE USERNAME=:username");
    $query->bindParam("username", $username, PDO::PARAM_STR);
    $query->execute();

    $result = $query->fetch(PDO::FETCH_ASSOC);

    if (!$result || !password_verify($password, $result['password_hash'])) {
        echo '<p class="error">¡Credenciales incorrectas!, Inténtalo de nuevo...</p>';
    } else {
        // Si la autenticación es exitosa, establecemos la sesión
        $_SESSION['user_id'] = $result['id'];  // Asegúrate de que el valor sea el ID del usuario o algo que identifique al usuario
        header('Location: ../../templates/product/product_list.php');
        exit();
    }
}
?>






El archivo logout:

<?php
session_start();
session_destroy(); // Elimina todas las variables de sesión
header('Location: ../../templates/forms/login.php'); // Redirige al login
exit();
?>




Y el archivo registration:

<?php
include('../db/config.php');
session_start();
if (isset($_POST['register'])) {
    $username = $_POST['username'];
    $email = $_POST['email'];
    $password = $_POST['password'];
    $password_hash = password_hash($password, PASSWORD_BCRYPT);

    // Verificar si el email ya está registrado
    $query = $connection->prepare("SELECT * FROM users WHERE EMAIL=:email");
    echo "Hola";
    $query->bindParam("email", $email, PDO::PARAM_STR);
    $query->execute();

    if ($query->rowCount() > 0) {
        echo '<p class="error">¡La dirección de correo ya existe!</p>';
    } else {
        // Insertar nuevo usuario
        try {
            $query = $connection->prepare("INSERT INTO users(USERNAME, PASSWORD_HASH, EMAIL) VALUES (:username, :password_hash, :email)");
            $query->bindParam("username", $username, PDO::PARAM_STR);
            $query->bindParam("password_hash", $password_hash, PDO::PARAM_STR);
            $query->bindParam("email", $email, PDO::PARAM_STR);
            $result = $query->execute();

            if ($result) {
                header('Location: ../../templates/forms/login.php');
            } else {
                echo '<p class="error">¡Algo fue mal al registrar el usuario!</p>';
            }
        } catch (PDOException $e) {
            echo '<p class="error">Error: ' . $e->getMessage() . '</p>';
        }
    }
}
?>






En la carpeta templates tengo las carpetas forms y product. Dentro de forms tengo los archivos login:

<!DOCTYPE html>
<html>
<head>
    <title>Iniciar Sesión</title>
</head>
<body>
    <h1>Login</h1>
<form method="POST" action="../../controller/forms/login.php" name="signin-form">
    <div class="form-element">
        <label>Username</label>
        <input type="text" name="username" pattern="[a-zA-Z0-9]+" required />
    </div>
    <div class="form-element">
        <label>Password</label>
        <input type="password" name="password" required />
    </div>
    <button type="submit" name="login" value="login">Log In</button>
</form>

<p>¿No tienes cuenta? <a href="register.php">Regístrate aquí</a></p>

</body>
</html>




El archivo register:

<!DOCTYPE html>
<html>
<head>
    <title>Registro</title>
</head>
<body>
    <h1>Regístrate</h1>
<form method="POST" action="../../controller/forms/registration.php" name="signup-form">
    <div class="form-element">
        <label>Username</label>
        <input type="text" name="username" pattern="[a-zA-Z0-9]+" required />
    </div>
    <div class="form-element">
        <label>Email</label>
        <input type="email" name="email" required />
    </div>
    <div class="form-element">
        <label>Password</label>
        <input type="password" name="password" required />
    </div>
    <button type="submit" name="register" value="register">Register</button>
</form>

<p><a href="login.php">Volver al Login</a></p>
</body>
</html>



Y dentro de la carpeta styles simplemente tengo un archivo que se llama styleform.css


Dentro de la carpeta product, tengo un archivo product_list:

<?php
session_start();  // Al principio de todo

// Verificar si el usuario está autenticado
if (!isset($_SESSION['user_id'])) {
    // Redirige al login si no está autenticado
    header('Location: ../templates/forms/login.php');
    exit();  // No debe ejecutar más código después de la redirección
}

// Si el usuario está autenticado, puedes proceder a mostrar los productos
include('../../controller/db/config.php');

$query = $connection->prepare("SELECT * FROM products ORDER BY created_at DESC");
$query->execute();
$products = $query->fetchAll(PDO::FETCH_ASSOC);

?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Lista de Productos</title>
</head>
<body>
    <h1>Lista de Productos</h1>

    <!-- Formulario para cerrar sesión -->
    <form method="POST" action="../../controller/forms/logout.php">
        <button type="submit">Cerrar sesión</button>
    </form>

    <!-- Tabla de productos -->
    <table border="1">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Descripción</th>
                <th>Precio</th>
                <th>Stock</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            <?php if (!empty($products)): ?>
                <?php foreach ($products as $product): ?>
                    <tr>
                        <td><?php echo htmlspecialchars($product['id']); ?></td>
                        <td><?php echo htmlspecialchars($product['name']); ?></td>
                        <td><?php echo htmlspecialchars($product['description']); ?></td>
                        <td><?php echo htmlspecialchars($product['price']); ?></td>
                        <td><?php echo htmlspecialchars($product['stock']); ?></td>
                        <td>
                            <a href="#">Editar</a> | 
                            <a href="#">Eliminar</a>
                        </td>
                    </tr>
                <?php endforeach; ?>
            <?php else: ?>
                <tr>
                    <td colspan="6">No hay productos disponibles</td>
                </tr>
            <?php endif; ?>
        </tbody>
    </table>
</body>
</html>







Y la carpeta styles donde dentro tengo el archivo styleproduct.css


Me funciona todo correctamente, pero si cierro sesión y me lleva al login y pongo en la barra de navegador la url de la tabla de productos, me redirige a la página sin necesidad de loguarme
